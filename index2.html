<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üõ∞Ô∏è</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    touch-action: manipulation;
}

#gameCanvas {
    background: url('assets2/grass_bg.png') repeat;
    background-size: cover;
    width: 100%;
    height: 80vh;
}

.controls {
    display: flex;
    justify-content: center;
    margin-top: 10px;
    gap: 20px;
}

button {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: none;
    background: #ffffff;
    box-shadow: 0 6px 10px rgba(0,0,0,0.15);
    font-size: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

button:active {
    transform: scale(0.95);
}

/* ===== Â∞çË©± UI ===== */
#dialogueOverlay {
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}
    
#dialogueBox {
    background: #111;
    color: #fff;
    padding: 20px;
    border-radius: 16px;
    width: 85%;
    max-width: 520px;
    font-size: 15px;
    line-height: 1.6;
    white-space: pre-wrap;
}

.dialogue-buttons {
    margin-top: 16px;
    display: flex;
    justify-content: center;
    gap: 12px;
}

.dialogue-buttons button {
    width: auto;
    height: auto;
    padding: 10px 16px;
    border-radius: 12px;
    font-size: 14px;
}
</style>
</head>

<body>

<canvas id="gameCanvas"></canvas>

<div class="controls">
    <button onclick="moveLeft()">‚á¶</button>
    <button onclick="moveRight()">‚á®</button>
</div>

<audio id="bgm" src="assets2/bgm.mp3" loop></audio>

<!-- Â∞çË©±Â±§ -->
<div id="dialogueOverlay">
    <div id="dialogueBox">
        <div id="dialogueText"></div>
        <div class="dialogue-buttons" id="dialogueBtns"></div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight * 0.8;

/* ===== Ë≥áÊ∫ê ===== */
const character = new Image();
character.src = 'assets2/character.png';
const character2 = new Image();
character2.src = 'assets2/character2.png';
let currentCharacterImage = character;

const tree = new Image();
tree.src = 'assets2/tree.png';
const tree2 = new Image();
tree2.src = 'assets2/tree2.png';
let currentTreeImage = tree;

const bgm = document.getElementById('bgm');

/* ===== ÁãÄÊÖã ===== */
let x = 100;
let y = 390;
let speed = 7.5;
let bgmPlayed = false;

let treeX = canvas.width / 2 + 40;
let treeY = 250;
let treeMoveDistance = 0;
let treeDirection = 1;

let dialogueShown = false;
let storyLocked = false;

let leftWallDialogueCooldown = false;
let rightWallDialogueCooldown = false;
let needToShowWallDialogue = false;
let needToShowRightWallDialogue = false;

/* ===== UI ===== */
const overlay = document.getElementById('dialogueOverlay');
const textBox = document.getElementById('dialogueText');
const btnBox = document.getElementById('dialogueBtns');

function openDialogue(text, buttons=[]) {
    textBox.textContent = text;
    btnBox.innerHTML = '';
    buttons.forEach(b => {
        const btn = document.createElement('button');
        btn.textContent = b.text;
        btn.onclick = b.onClick;
        btnBox.appendChild(btn);
    });
    overlay.style.display = 'flex';
}

function closeDialogue() {
    overlay.style.display = 'none';
    dialogueShown = false;
}

/* ===== Áπ™Ë£Ω ===== */
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(currentCharacterImage, x, y, 80, 120);
    ctx.drawImage(currentTreeImage, treeX + treeMoveDistance, treeY, 80, 120);

    const nearTree =
        x > (treeX + treeMoveDistance - 20) &&
        x < (treeX + treeMoveDistance + 60);

    if (nearTree && !dialogueShown && !storyLocked) {
        dialogueShown = true;
        openDialogue(
            "‰Ω†ÂèàÈÅáÂà∞‰∏ÄÈöªËø∑Ë∑ØÁöÑÊÄ™‰∫∫‰∫ÜÔºÅ\nË¶ÅË∑ü‰ªñËÅäÂ§©ÂóéÔºü",
            [
                { text: "ÂñúÂãíË°ùÂππ", onClick: startStory },
                { text: "Âø´Ê≠•ÈÄÉË∑ë", onClick: () => {
                    openDialogue("ÊãúË®óËÅä‰∏Ä‰∏ãÂï¶üíî", [
                        { text: "Â•ΩÂï¶‚Ä¶", onClick: closeDialogue }
                    ]);
                }}
            ]
        );
    }

    if (!nearTree && overlay.style.display === 'none') {
        dialogueShown = false;
    }
}

/* ===== ÂäáÊÉÖ ===== */
function startStory() {
    storyLocked = true;
    openDialogue("ÈÇ£ÊàëË¶ÅÈñãÂßãË™çÁúüË™™‰∫ÜÂñî", []);
    setTimeout(() => {
        closeDialogue();
        showTypingMessage(`ÂòøÈõ®ÁëÑÔΩûÂæàÈñãÂøÉËÉΩË™çË≠ò‰Ω†„ÄÇ

‰Ω†ÁúüÁöÑ‰∏ÄÁõ¥Áµ¶Êàë‰∏ÄÁ®ÆÂæàÁâπÂà•ÁöÑÊÑüË¶∫ÔºåÂæàÊúâÊÉ≥Ê≥ïÔºå‰πüÂæàÊ∏ÖÊ•öËá™Â∑±ÊÉ≥ÂÅö‰ªÄÈ∫º„ÄÅÊÉ≥ËøΩÊ±Ç‰ªÄÈ∫º„ÄÇÈÄô‰ªΩÁØ§ÂÆöËàáË™çÁúüÔºåÊòØÊàëÂæàÊ¨£Ë≥û„ÄÅ‰πüÂæà‰Ω©ÊúçÁöÑÂú∞Êñπ„ÄÇ

‰∏çÈÅéÈÇ£Â§©‰∏ÄËµ∑ÂéªÂ§©ÊñáÈ§®ÔºåÊàëÂèàÁúãË¶ã‰∫Ü‰∏ç‰∏ÄÊ®£ÁöÑ‰Ω†„ÄÇÊúÉÊäïÂÖ•„ÄÅÊúÉÊîæÈõª„ÄÅÊúÉÂÉèÂ∞èÂ≠©Â≠ê‰∏ÄÊ®£ÂñÆÁ¥îÈñãÂøÉÔºåÈÇ£‰∏ÄÂàªÁúüÁöÑÂæàÂèØÊÑõÔºå‰πüËÆì‰∫∫Âç∞Ë±°ÂæàÊ∑±„ÄÇ

ÊâÄ‰ª•ÊàëÁúüÂøÉÂ∏åÊúõÔºå‰Ω†‰ª•ÂæåÁöÑÊØè‰∏ÄÂ§©ÔºåÈÉΩËÉΩÂÉèÈÇ£Â§©‰∏ÄÊ®£Ëá™Âú®ÂèàÂø´Ê®ÇÔºå‰πüÂà•Âøò‰∫ÜÁõ∏‰ø°Ëá™Â∑±„ÄÇ

ÊúÄÂæåÈÇÑÊúâ‰∏ÄÂÄãÈö±ËóèÂú∞Âúñ‰Ω†ÂøÖÈ†àÊâæ‰ªñÔΩû‚úåÔ∏è`);
    }, 800);
}

/* ===== ÊâìÂ≠óÊ©ü ===== */
function showTypingMessage(message) {
    const div = document.createElement('div');
    Object.assign(div.style,{
        position:'fixed',top:'40%',left:'50%',
        transform:'translate(-50%,-50%)',
        background:'rgba(255,255,255,0.95)',
        padding:'20px',borderRadius:'12px',
        width:'85%',maxWidth:'520px',
        whiteSpace:'pre-wrap',lineHeight:'1.6',
        zIndex:9999,transition:'opacity 1s'
    });
    document.body.appendChild(div);

    let i=0;
    const t=setInterval(()=>{
        div.textContent+=message.charAt(i++);
        if(i>=message.length){
            clearInterval(t);
            setTimeout(()=>{
                div.style.opacity='0';
                setTimeout(()=>{div.remove();spawnHearts();},1000);
            },2000);
        }
    },80);
}

/* ===== ÊÑõÂøÉ ===== */
function spawnHearts(){
    for(let i=0;i<30;i++){
        const h=document.createElement('div');
        h.textContent='üíô';
        Object.assign(h.style,{
            position:'fixed',left:'50%',top:'50%',
            transform:'translate(-50%,-50%)',
            fontSize:(20+Math.random()*20)+'px',
            transition:'all 2s',zIndex:9999
        });
        document.body.appendChild(h);
        setTimeout(()=>{
            h.style.transform=`translate(${(Math.random()-0.5)*200}px,${-200-Math.random()*200}px)`;
            h.style.opacity=0;
        },100);
        setTimeout(()=>h.remove(),3000);
    }
}

/* ===== ÂãïÁï´ ===== */
function animateTree(){
    treeMoveDistance+=treeDirection*0.5;
    if(treeMoveDistance>3||treeMoveDistance<-3) treeDirection*=-1;
    draw();
    requestAnimationFrame(animateTree);
}

function dropTree(cb){
    const start=treeY, end=410, startT=performance.now();
    function anim(t){
        const p=Math.min((t-startT)/3000,1);
        treeY=start+(end-start)*p;
        draw();
        if(p<1) requestAnimationFrame(anim);
        else cb();
    }
    requestAnimationFrame(anim);
}

/* ===== ÊéßÂà∂ ===== */
function playBGM(){ if(!bgmPlayed){bgm.play();bgmPlayed=true;} }
function moveLeft(){
    playBGM(); x=Math.max(0,x-speed);
    if(x===0&&!leftWallDialogueCooldown){
        leftWallDialogueCooldown=true;
        openDialogue("Â∞±ÈÄôÈ∫ºÊÉ≥ÂõûÂéª‰∏äÂÄãÂú∞ÂúñÂïäÔºÅ",[{
            text:"ÂõûÂéª",onClick:()=>location.href="index.html"
        }]);
        setTimeout(()=>leftWallDialogueCooldown=false,3000);
    }
}
function moveRight(){
    playBGM(); x=Math.min(canvas.width-80,x+speed);
    if(x===canvas.width-80&&!rightWallDialogueCooldown){
        rightWallDialogueCooldown=true;
        openDialogue("ÊÅ≠ÂñúÁôºÁèæÈö±ËóèÂú∞ÂúñÔºÅ",[{
            text:"ÂâçÂæÄ",onClick:()=>location.href="index3.html"
        }]);
        setTimeout(()=>rightWallDialogueCooldown=false,3000);
    }
}

/* ===== ÂïüÂãï ===== */
draw();
dropTree(()=>animateTree());
</script>

</body>
</html>
