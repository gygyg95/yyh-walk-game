<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãŠ™ï¸</title>
<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    touch-action: manipulation;
}
#gameCanvas {
    background: url('assets3/grass_bg.png') repeat;
    background-size: cover;
    width: 100%;
    height: 80vh;
}
.controls {
    display: flex;
    justify-content: center;
    margin-top: 10px;
    gap: 20px;
}
button {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: none;
    background: #ffffff;
    box-shadow: 0 6px 10px rgba(0,0,0,0.15);
    transition: background 0.3s, transform 0.2s;
    font-size: 32px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}
button:active {
    background: #e0f7fa;
    transform: scale(0.95);
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div class="controls">
    <button onclick="moveLeft()">ğŸ”™</button>
    <button onclick="moveRight()">ğŸ”œ</button>
</div>

<audio id="bgm" src="assets3/bgm.mp3" loop></audio>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// è§’è‰²åœ–
const character = new Image();
character.src = 'assets3/character.png';
const character2 = new Image();
character2.src = 'assets3/character2.png';
let currentCharacterImage = character;

// æ¨¹åœ–
const tree = new Image();
tree.src = 'assets3/tree.png';
const tree2 = new Image();
tree2.src = 'assets3/tree2.png';
const tree5 = new Image();
tree5.src = 'assets3/tree5.png';
const tree6 = new Image();
tree6.src = 'assets3/tree6.png';
let currentTreeImage = tree;

const bgm = document.getElementById('bgm');

let x = 100;
let y = 430;
let speed = 7.5;
let dialogueShown = false;
let bgmPlayed = false;
let treeX = canvas.width / 2 + 40;
let treeY = 410;
let treeDirection = 1;
let treeMoveDistance = 0;
let leftWallDialogueCooldown = false;
let needToShowWallDialogue = false;
let treeSpecialEffectActive = false;
let isTypingMessage = false;
let treeForeverFlash = false;

canvas.width = window.innerWidth;
canvas.height = window.innerHeight * 0.8;

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(currentCharacterImage, x, y, 80, 120);
    ctx.drawImage(currentTreeImage, treeX, treeY + treeMoveDistance, 80, 120);

    if (!isTypingMessage) {
        if (x > (treeX - 20) && x < (treeX + 60)) {
            if (!dialogueShown) {
                setTimeout(showDialogue, 300);
                dialogueShown = true;
            }
        } else {
            dialogueShown = false;
        }
    }
}

function animateTree() {
    treeMoveDistance += treeDirection * 0.5;
    if (treeMoveDistance > 3 || treeMoveDistance < -3) {
        treeDirection *= -1;
    }
    draw();
    requestAnimationFrame(animateTree);
}

function randomTreeEffect() {
    if (treeSpecialEffectActive || treeForeverFlash) return;
    setTimeout(() => {
        currentTreeImage = tree;
        draw();
        setTimeout(() => {
            currentTreeImage = tree2;
            draw();
            randomTreeEffect();
        }, 500);
    }, Math.random() * 2000 + 2000);
}

function randomCharacterEffect() {
    setTimeout(() => {
        currentCharacterImage = character2;
        draw();
        setTimeout(() => {
            currentCharacterImage = character;
            draw();
            randomCharacterEffect();
        }, 500);
    }, Math.random() * 3000 + 2000);
}

function randomBgEffect() {
    setTimeout(() => {
        canvas.style.backgroundImage = "url('assets3/grass_bg.png')";
        setTimeout(() => {
            canvas.style.backgroundImage = "url('assets3/grass_bg2.png')";
            randomBgEffect();
        }, 250);
    }, Math.random() * 2000 + 2000);
}

function playBGM() {
    if (!bgmPlayed) {
        bgm.play();
        bgmPlayed = true;
    }
}

function moveLeft() {
    playBGM();
    x -= speed;
    if (x <= 0) {
        x = 0;
        if (!leftWallDialogueCooldown) {
            leftWallDialogueCooldown = true;
            needToShowWallDialogue = true;
            setTimeout(() => {
                leftWallDialogueCooldown = false;
            }, 3000);
        }
    }
    draw();
}

function moveRight() {
    playBGM();
    x += speed;
    if (x > canvas.width - 80) x = canvas.width - 80;
    draw();
}

// ç¢°åˆ°æ¨¹å¾Œè§¸ç™¼æ‰“å­—ï¼Œä¸¦æ°¸ä¹…tree5/4
function showDialogue() {
    if (treeForeverFlash) return;
    treeSpecialEffectActive = true;
    treeForeverFlash = true;
    flashTreeForeverEffect();

    setTimeout(() => {
        showTypingMessage(`ä¸æ„§æ˜¯è°æ˜çš„ä½ ï¼Œæˆ‘å°±çŸ¥é“ä½ ä¸€å®šèƒ½ç™¼ç¾é€™å€‹è¢«è—èµ·ä¾†çš„åœ°åœ–ã€‚

é€™å€‹å°å°çš„ç¶²é éŠæˆ²ï¼Œæ˜¯æˆ‘èŠ±äº†ä¸å°‘å¿ƒæ€ï¼Œæ‚„æ‚„ç‚ºä½ æº–å‚™çš„ã€‚

æˆ–è¨±å®ƒä¸¦ä¸å®Œç¾ï¼Œä½†æˆ‘å¸Œæœ›ï¼Œå®ƒèƒ½åœ¨ä½ çš„ä¸–ç•Œè£¡ï¼Œç•™ä¸‹é‚£éº¼ä¸€é»æº«æŸ”çš„ç—•è·¡ã€‚

å…¶å¯¦æˆ‘ä¸€ç›´å¾ˆåš®å¾€é‚£æ¨£çš„æœªä¾†ï¼Œé†’ä¾†å°±èƒ½çœ‹åˆ°ä½ çš„ç¬‘å®¹ï¼Œä¸Šç­çš„æ™‚å€™æœƒé–‹å§‹æƒ³ï¼Œä¸‹ç­è¦ç…®ä»€éº¼å¥½åƒçš„çµ¦ä½ ï¼Œ

ä¹Ÿå¾ˆæƒ³åœ¨å¾€å¾Œçš„æ—¥å­è£¡ï¼Œå’Œä½ ä¸€èµ·èµ°éæ¯ä¸€å€‹å¹³å‡¡çš„æ—¥å­ã€æ¯ä¸€å€‹ç¯€æ—¥ï¼Œæ…¢æ…¢æ¢ç´¢é€™å€‹ä¸–ç•Œã€‚

é€™äº›æƒ³æ³•ï¼Œæˆ‘éƒ½æ˜¯å¾ˆèªçœŸåœ°æ”¾åœ¨å¿ƒè£¡çš„ï¼Œåªæ˜¯æƒ³èª å¯¦åœ°å‘Šè¨´ä½ ï¼Œä¹Ÿæƒ³å•å•ä½ ï¼Œ

ä½ é¡˜ä¸é¡˜æ„ï¼Œå’Œæˆ‘ä¸€èµ·èµ°çœ‹çœ‹å‘¢ï¼Ÿ

(æˆ‘ä¸ç®¡æˆ‘å°±æ˜¯è¦å…ˆæ”¾ç…™ç«)`);
    }, 1000);
}

// æ‰“å­—æ©Ÿ + ä¿ç•™æ·¡æ·¡æ–‡å­— + ç„¡é™ç…™ç«
function showTypingMessage(message) {
    isTypingMessage = true;

    const typingDiv = document.createElement('div');
    typingDiv.style.position = 'fixed';
    typingDiv.style.top = '40%';
    typingDiv.style.left = '50%';
    typingDiv.style.transform = 'translate(-50%, -50%)';
    typingDiv.style.background = 'rgba(255, 255, 255, 0.9)';
    typingDiv.style.padding = '20px';
    typingDiv.style.borderRadius = '10px';
    typingDiv.style.fontSize = '12px';
    typingDiv.style.fontFamily = 'monospace';
    typingDiv.style.color = '#000';
    typingDiv.style.zIndex = '9999';
    typingDiv.style.width = '80%';
    typingDiv.style.maxWidth = '500px';
    typingDiv.style.whiteSpace = 'pre-wrap';
    typingDiv.style.lineHeight = '1.5';
    typingDiv.style.transition = 'opacity 1s ease';
    document.body.appendChild(typingDiv);

    let index = 0;
    const interval = setInterval(() => {
        if (index < message.length) {
            typingDiv.textContent += message.charAt(index);
            index++;
        } else {
            clearInterval(interval);
            setTimeout(() => {
                typingDiv.style.opacity = '0.5';
                isTypingMessage = false;
                triggerFireworks(); // é–‹å§‹ç„¡é™ç…™ç«
            }, 1000);
        }
    }, 100);
}

// ç„¡é™æ”¾ç…™ç«
function triggerFireworks() {
    createSingleFirework();
    setTimeout(triggerFireworks, 500); // æ¯0.5ç§’æŒçºŒæ”¾ç…™ç«
}

function createSingleFirework() {
    const colors = ['#ff4c4c', '#ffd93d', '#3dd9ff', '#8c52ff', '#ff6ec7'];
    const fireworkX = Math.random() * canvas.width;
    const fireworkY = Math.random() * canvas.height / 2;
    const particles = [];

    for (let i = 0; i < 30; i++) {
        particles.push({
            x: fireworkX,
            y: fireworkY,
            radius: 2 + Math.random() * 2,
            color: colors[Math.floor(Math.random() * colors.length)],
            angle: Math.random() * 2 * Math.PI,
            speed: Math.random() * 5 + 2,
            alpha: 1
        });
    }

    function animateFirework() {
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(currentCharacterImage, x, y, 80, 120);
        ctx.drawImage(currentTreeImage, treeX, treeY + treeMoveDistance, 80, 120);

        particles.forEach(p => {
            p.x += Math.cos(p.angle) * p.speed;
            p.y += Math.sin(p.angle) * p.speed;
            p.alpha -= 0.02;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = Math.max(p.alpha, 0);
            ctx.fill();
        });

        ctx.restore();

        if (particles.some(p => p.alpha > 0)) {
            requestAnimationFrame(animateFirework);
        }
    }
    animateFirework();
}

// æ°¸ä¹…tree5/4é–ƒçˆ
function flashTreeForeverEffect() {
    setInterval(() => {
        currentTreeImage = (currentTreeImage === tree5) ? tree6 : tree5;
        draw();
    }, 250);
}

function gameLoop() {
    if (needToShowWallDialogue) {
        needToShowWallDialogue = false;
        const confirmResult = confirm("ç¢ºå®šè¦å›å»ä¸Šå€‹åœ°åœ–å—ï¼Ÿ");
        if (confirmResult) {
            window.location.href = "index2.html";
        }
    }
    requestAnimationFrame(gameLoop);
}

// å•Ÿå‹•
draw();
animateTree();
randomTreeEffect();
randomCharacterEffect();
randomBgEffect();
gameLoop();
</script>

</body>
</html>
